<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-guides/migration/from-v2-to-v3" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.0">
<title data-rh="true">From v2 to v3 | KafkaFlow</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://farfetch.github.io/kafkaflow/docs/guides/migration/from-v2-to-v3"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="From v2 to v3 | KafkaFlow"><meta data-rh="true" name="description" content="KafkaFlow version 3 brings several significant changes and improvements. This guide will help you navigate through the migration process from version 2 to version 3."><meta data-rh="true" property="og:description" content="KafkaFlow version 3 brings several significant changes and improvements. This guide will help you navigate through the migration process from version 2 to version 3."><link data-rh="true" rel="icon" href="/kafkaflow/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://farfetch.github.io/kafkaflow/docs/guides/migration/from-v2-to-v3"><link data-rh="true" rel="alternate" href="https://farfetch.github.io/kafkaflow/docs/guides/migration/from-v2-to-v3" hreflang="en"><link data-rh="true" rel="alternate" href="https://farfetch.github.io/kafkaflow/docs/guides/migration/from-v2-to-v3" hreflang="x-default"><link rel="stylesheet" href="/kafkaflow/assets/css/styles.1cbafb68.css">
<script src="/kafkaflow/assets/js/runtime~main.4626e805.js" defer="defer"></script>
<script src="/kafkaflow/assets/js/main.2567ed9d.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://farfetch.github.io/kafkaflow/" target="_self" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/kafkaflow/img/logo.svg" alt="KafkaFlow" class="themedComponent_mlkZ themedComponent--light_NVdE" height="32"><img src="/kafkaflow/img/logo.svg" alt="KafkaFlow" class="themedComponent_mlkZ themedComponent--dark_xIcU" height="32"></div></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link active" aria-haspopup="true" aria-expanded="false" role="button" href="/kafkaflow/docs/">3.x</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/kafkaflow/docs/guides/migration/from-v2-to-v3">3.x</a></li><li><a class="dropdown__link" href="/kafkaflow/docs/2.x/">2.x</a></li></ul></div><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/kafkaflow/docs/">Docs</a><a class="navbar__item navbar__link" href="/kafkaflow/extensions">Extensions</a><a class="navbar__item navbar__link" href="/kafkaflow/community">Community</a><a href="https://github.com/farfetch/kafkaflow" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/kafkaflow/docs/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/kafkaflow/docs/category/getting-started">Getting Started</a><button aria-label="Expand sidebar category &#x27;Getting Started&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/kafkaflow/docs/category/guides">Guides</a><button aria-label="Collapse sidebar category &#x27;Guides&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kafkaflow/docs/guides/configuration">Configuration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kafkaflow/docs/guides/producers">Producers</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/kafkaflow/docs/category/consumers">Consumers</a><button aria-label="Expand sidebar category &#x27;Consumers&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/kafkaflow/docs/category/middlewares">Middlewares</a><button aria-label="Expand sidebar category &#x27;Middlewares&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kafkaflow/docs/guides/compression">Compression</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kafkaflow/docs/guides/logging">Logging</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/kafkaflow/docs/category/administration">Administration</a><button aria-label="Expand sidebar category &#x27;Administration&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kafkaflow/docs/guides/authentication">Authentication</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kafkaflow/docs/guides/global-events">Global Events</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kafkaflow/docs/guides/open-telemetry">OpenTelemetry</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kafkaflow/docs/guides/dependency-injection">Dependency Injection</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/kafkaflow/docs/category/migration">Migration</a><button aria-label="Collapse sidebar category &#x27;Migration&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/kafkaflow/docs/guides/migration/from-v2-to-v3">From v2 to v3</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/kafkaflow/docs/category/reference">Reference</a><button aria-label="Expand sidebar category &#x27;Reference&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/kafkaflow/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/kafkaflow/docs/category/guides"><span itemprop="name">Guides</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/kafkaflow/docs/category/migration"><span itemprop="name">Migration</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">From v2 to v3</span><meta itemprop="position" content="3"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: 3.x</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>From v2 to v3</h1>
<p>KafkaFlow version 3 brings several significant changes and improvements. This guide will help you navigate through the migration process from version 2 to version 3.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="table-of-contents">Table of Contents<a href="#table-of-contents" class="hash-link" aria-label="Direct link to Table of Contents" title="Direct link to Table of Contents">​</a></h2>
<ul>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#update-package-references">Update package references</a></li>
<li><a href="#breaking-changes">Breaking Changes</a>
<ul>
<li><a href="#1-update-to-net-6-with-admin-packages">1. Update to .NET 6 with Admin Packages</a></li>
<li><a href="#2-ui-dashboard-url-change">2. UI Dashboard URL Change</a></li>
<li><a href="#3-removed-packages-and-core-changes">3. Removed Packages and Core Changes</a>
<ul>
<li><a href="#31-removed-packages">3.1 Removed Packages</a></li>
<li><a href="#32-serializer-and-compressor-interface-segregation">3.2 Serializer and Compressor Interface Segregation</a></li>
<li><a href="#33-consumer-batching-configuration">3.3 Consumer Batching Configuration</a></li>
<li><a href="#34-async-support-for-message-type-resolvers-and-schema-registry-resolvers">3.4. Async Support for Message Type Resolvers and Schema Registry Resolvers</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#new-features">New Features</a>
<ul>
<li><a href="#1-dynamic-workers-calculation">1. Dynamic Workers Calculation</a>
<ul>
<li><a href="#11-dynamic-worker-pool-scaling-configuration">1.1 Dynamic Worker Pool Scaling Configuration</a></li>
<li><a href="#12-improved-mechanism-for-signalling-message-processing-completion">1.2 Improved Mechanism for Signalling Message Processing Completion</a></li>
<li><a href="#13-expose-worker-events-to-client-applications">1.3 Expose Worker Events to Client Applications</a></li>
<li><a href="#14-improve-dependency-injection-scope-management">1.4 Improve Dependency Injection Scope Management</a></li>
</ul>
</li>
<li><a href="#2-improved-worker-distribution-strategy">2. Improved Worker Distribution Strategy</a></li>
</ul>
</li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a href="#prerequisites" class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites">​</a></h2>
<p>As .NET Core 3.1 has reached the end of support in its lifecycle, we have updated references to Core Packages (<code>Microsoft.*</code> and <code>System.*</code>) to version 6.</p>
<p>While the KafkaFlow core and most of the extension packages are still targeting <code>netstandard2.0</code> which supports a range of runtimes, we recommend with this v3 update to target at least .NET 6 in applications using KafkaFlow.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="update-package-references">Update package references<a href="#update-package-references" class="hash-link" aria-label="Direct link to Update package references" title="Direct link to Update package references">​</a></h2>
<p>To update to KafkaFlow v3, change the <code>Version</code> related to KafkaFlow packages to the latest v3 available in each project referencing KafkaFlow packages.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;ItemGroup&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-   &lt;PackageReference Include=&quot;KafkaFlow&quot; Version=&quot;2.5.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-   &lt;PackageReference Include=&quot;KafkaFlow.Abstractions&quot; Version=&quot;2.5.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-   &lt;PackageReference Include=&quot;KafkaFlow.Admin&quot; Version=&quot;2.5.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-   &lt;PackageReference Include=&quot;KafkaFlow.Admin.Dashboard&quot; Version=&quot;2.5.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-   &lt;PackageReference Include=&quot;KafkaFlow.Admin.WebApi&quot; Version=&quot;2.5.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-   &lt;PackageReference Include=&quot;KafkaFlow.BatchConsume&quot; Version=&quot;2.5.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-   &lt;PackageReference Include=&quot;KafkaFlow.Compressor&quot; Version=&quot;2.5.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-   &lt;PackageReference Include=&quot;KafkaFlow.Compressor.Gzip&quot; Version=&quot;2.5.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-   &lt;PackageReference Include=&quot;KafkaFlow.Extensions.Hosting&quot; Version=&quot;2.5.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-   &lt;PackageReference Include=&quot;KafkaFlow.LogHandler.Console&quot; Version=&quot;2.5.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-   &lt;PackageReference Include=&quot;KafkaFlow.LogHandler.Microsoft&quot; Version=&quot;2.5.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-   &lt;PackageReference Include=&quot;KafkaFlow.Microsoft.DependencyInjection&quot; Version=&quot;2.5.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-   &lt;PackageReference Include=&quot;KafkaFlow.OpenTelemetry&quot; Version=&quot;2.5.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-   &lt;PackageReference Include=&quot;KafkaFlow.SchemaRegistry&quot; Version=&quot;2.5.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-   &lt;PackageReference Include=&quot;KafkaFlow.Serializer&quot; Version=&quot;2.5.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-   &lt;PackageReference Include=&quot;KafkaFlow.Serializer.JsonCore&quot; Version=&quot;2.5.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-   &lt;PackageReference Include=&quot;KafkaFlow.Serializer.NewtonsoftJson&quot; Version=&quot;2.5.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-   &lt;PackageReference Include=&quot;KafkaFlow.Serializer.ProtobufNet&quot; Version=&quot;2.5.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-   &lt;PackageReference Include=&quot;KafkaFlow.Serializer.SchemaRegistry.ConfluentAvro&quot; Version=&quot;2.5.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-   &lt;PackageReference Include=&quot;KafkaFlow.Serializer.SchemaRegistry.ConfluentJson&quot; Version=&quot;2.5.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-   &lt;PackageReference Include=&quot;KafkaFlow.Serializer.SchemaRegistry.ConfluentProtobuf&quot; Version=&quot;2.5.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-   &lt;PackageReference Include=&quot;KafkaFlow.TypedHandler&quot; Version=&quot;2.5.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-   &lt;PackageReference Include=&quot;KafkaFlow.Unity&quot; Version=&quot;2.5.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+   &lt;PackageReference Include=&quot;KafkaFlow&quot; Version=&quot;3.0.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+   &lt;PackageReference Include=&quot;KafkaFlow.Abstractions&quot; Version=&quot;3.0.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+   &lt;PackageReference Include=&quot;KafkaFlow.Admin&quot; Version=&quot;3.0.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+   &lt;PackageReference Include=&quot;KafkaFlow.Admin.Dashboard&quot; Version=&quot;3.0.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+   &lt;PackageReference Include=&quot;KafkaFlow.Admin.WebApi&quot; Version=&quot;3.0.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+   &lt;PackageReference Include=&quot;KafkaFlow.Compressor.Gzip&quot; Version=&quot;3.0.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+   &lt;PackageReference Include=&quot;KafkaFlow.Extensions.Hosting&quot; Version=&quot;3.0.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+   &lt;PackageReference Include=&quot;KafkaFlow.LogHandler.Console&quot; Version=&quot;3.0.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+   &lt;PackageReference Include=&quot;KafkaFlow.LogHandler.Microsoft&quot; Version=&quot;3.0.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+   &lt;PackageReference Include=&quot;KafkaFlow.Microsoft.DependencyInjection&quot; Version=&quot;3.0.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+   &lt;PackageReference Include=&quot;KafkaFlow.OpenTelemetry&quot; Version=&quot;3.0.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+   &lt;PackageReference Include=&quot;KafkaFlow.SchemaRegistry&quot; Version=&quot;3.0.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+   &lt;PackageReference Include=&quot;KafkaFlow.Serializer.JsonCore&quot; Version=&quot;3.0.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+   &lt;PackageReference Include=&quot;KafkaFlow.Serializer.NewtonsoftJson&quot; Version=&quot;3.0.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+   &lt;PackageReference Include=&quot;KafkaFlow.Serializer.ProtobufNet&quot; Version=&quot;3.0.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+   &lt;PackageReference Include=&quot;KafkaFlow.Serializer.SchemaRegistry.ConfluentAvro&quot; Version=&quot;3.0.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+   &lt;PackageReference Include=&quot;KafkaFlow.Serializer.SchemaRegistry.ConfluentJson&quot; Version=&quot;3.0.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+   &lt;PackageReference Include=&quot;KafkaFlow.Serializer.SchemaRegistry.ConfluentProtobuf&quot; Version=&quot;3.0.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+   &lt;PackageReference Include=&quot;KafkaFlow.Unity&quot; Version=&quot;3.0.0&quot; /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/ItemGroup&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="breaking-changes">Breaking Changes<a href="#breaking-changes" class="hash-link" aria-label="Direct link to Breaking Changes" title="Direct link to Breaking Changes">​</a></h2>
<p>The update to v3 introduces some breaking changes. Please consider them when updating KafkaFlow.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-update-to-net-6-with-admin-packages">1. Update to .NET 6 with Admin Packages<a href="#1-update-to-net-6-with-admin-packages" class="hash-link" aria-label="Direct link to 1. Update to .NET 6 with Admin Packages" title="Direct link to 1. Update to .NET 6 with Admin Packages">​</a></h3>
<blockquote>
<p>Related Issues: <a href="https://github.com/Farfetch/kafkaflow/issues/298" target="_blank" rel="noopener noreferrer">#298</a> <a href="https://github.com/Farfetch/kafkaflow/issues/322" target="_blank" rel="noopener noreferrer">#322</a></p>
</blockquote>
<p>The target frameworks for ASP.NET Admin projects were updated from <code>netcoreapp3.1</code> to <code>.net6.0</code>.</p>
<p>If you are using the Admin packages (<code>KafkaFlow.Admin.Dashboard</code> and <code>KafkaFlow.Admin.WebApi </code>) you will need to target the .NET 6 runtime.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-ui-dashboard-url-change">2. UI Dashboard URL Change<a href="#2-ui-dashboard-url-change" class="hash-link" aria-label="Direct link to 2. UI Dashboard URL Change" title="Direct link to 2. UI Dashboard URL Change">​</a></h3>
<blockquote>
<p>Related Issues: <a href="https://github.com/Farfetch/kafkaflow/issues/303" target="_blank" rel="noopener noreferrer">#303</a></p>
</blockquote>
<p>To be in conformity with KafkaFlow naming conventions, the UI Dashboard URL has changed from <code>/kafka-flow</code> to <code>/kafkaflow</code>. Update any bookmarks or references accordingly.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-removed-packages-and-core-changes">3. Removed Packages and Core Changes<a href="#3-removed-packages-and-core-changes" class="hash-link" aria-label="Direct link to 3. Removed Packages and Core Changes" title="Direct link to 3. Removed Packages and Core Changes">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="31-removed-packages">3.1 Removed Packages<a href="#31-removed-packages" class="hash-link" aria-label="Direct link to 3.1 Removed Packages" title="Direct link to 3.1 Removed Packages">​</a></h4>
<blockquote>
<p>Related Issues: <a href="https://github.com/Farfetch/kafkaflow/issues/301" target="_blank" rel="noopener noreferrer">#301</a></p>
</blockquote>
<p>Because some KafkaFlow extension packages contained elements that belong to the core of KafkaFlow, these packages were removed and moved to the core library.
Most of these packages contained only interfaces or core functionalities that were moved to the core library while the concrete implementations continue to exist as separate packages to keep KafkaFlow&#x27;s modular design.</p>
<p>Here is the list of KafkaFlow packages that no longer exist in v3. In case you are referencing any of these packages, please remove those references since their references were moved to the core KafkaFlow package:</p>
<ul>
<li>KafkaFlow.TypedHandler</li>
<li>KafkaFlow.Compressor</li>
<li>KafkaFlow.Serializer</li>
<li>KafkaFlow.BatchConsume</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="32-serializer-and-compressor-interface-segregation">3.2 Serializer and Compressor Interface Segregation<a href="#32-serializer-and-compressor-interface-segregation" class="hash-link" aria-label="Direct link to 3.2 Serializer and Compressor Interface Segregation" title="Direct link to 3.2 Serializer and Compressor Interface Segregation">​</a></h4>
<blockquote>
<p>Related Issues: <a href="https://github.com/Farfetch/kafkaflow/issues/432" target="_blank" rel="noopener noreferrer">#432</a>, <a href="https://github.com/Farfetch/kafkaflow/issues/433" target="_blank" rel="noopener noreferrer">#433</a></p>
</blockquote>
<p>Before KafkaFlow v3, references were used on the consumer side, for example, <code>AddSerializer()</code> or <code>.AddCompressor()</code>. While this convention was used for simplicity&#x27;s sake to keep the same nomenclature as in the producer counterpart, the nomenclature can be error-prone since on the consumer side the behavior when using  <code>AddSerializer()</code> is adding a middleware for deserializing the message.</p>
<p>To fix this, on KafkaFlow v3, the <code>IDeserializer</code> and <code>IDecompressor</code> were created to segregate from the <code>ISerializer</code> and <code>ICompressor</code> interfaces.</p>
<p>In case you are configuring the consumer to deserialize and/or decompress a message similar to this configuration:</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AddConsumer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    consumerBuilder </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> consumerBuilder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Topic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;test-topic&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithGroupId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;group1&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AddMiddlewares</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            middlewares </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> middlewares</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-method function" style="color:#d73a49">AddCompressor</span><span class="token generic-method generic class-name punctuation" style="color:#393A34">&lt;</span><span class="token generic-method generic class-name">GzipMessageCompressor</span><span class="token generic-method generic class-name punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-method function" style="color:#d73a49">AddSerializer</span><span class="token generic-method generic class-name punctuation" style="color:#393A34">&lt;</span><span class="token generic-method generic class-name">JsonCoreSerializer</span><span class="token generic-method generic class-name punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">                </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The following changes need to be made when updating to KafkaFlow v3.</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AddConsumer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    consumerBuilder </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> consumerBuilder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Topic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;test-topic&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithGroupId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;group1&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AddMiddlewares</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            middlewares </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> middlewares</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-method function" style="color:#d73a49">AddDecompressor</span><span class="token generic-method generic class-name punctuation" style="color:#393A34">&lt;</span><span class="token generic-method generic class-name">GzipMessageDecompressor</span><span class="token generic-method generic class-name punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token generic-method function" style="color:#d73a49">AddDeserializer</span><span class="token generic-method generic class-name punctuation" style="color:#393A34">&lt;</span><span class="token generic-method generic class-name">JsonCoreDeserializer</span><span class="token generic-method generic class-name punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">                </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Not only the <code>.AddSerializer()</code> and <code>.AddCompressor()</code> were renamed to <code>.AddDeserializer()</code> and <code>.AddDecompressor()</code>, but also the concrete implementations like <code>JsonCoreSerializer</code> and <code>GzipMessageCompressor</code> were renamed to <code>JsonCoreDeserializer</code> and <code>GzipMessageDecompressor</code>. Please be aware that this change is only on the <strong>consumer side</strong>.</p>
<p>Having this segregation contributes to a more consistent name scheme together with the middleware behavior. Nevertheless, other changes related to this topic were made, here is a complete list of changes related to the segregation of <code>ISerializer</code> and <code>ICompressor</code> interfaces (<strong>consumer configuration</strong> only):</p>
<p>Related to Deserialization:</p>
<ul>
<li><code>IDeserializer</code> interface created.</li>
<li><code>.AddSerializer()</code> renamed to <code>.AddDeserializer()</code>.</li>
<li>Created <code>JsonCoreDeserializer </code>, <code>ProtobufNetDeserializer</code>, <code>ConfluentProtobufDeserializer</code>, <code>NewtonsoftJsonDeserializer</code>, <code>ConfluentJsonDeserializer</code> and <code>ConfluentAvroDeserializer</code> that implements the <code>.DeserializeAsync()</code> method.</li>
<li><code>.AddSingleTypeDeserializer()</code> renamed to <code>.AddSingleTypeDeserializer()</code></li>
<li><code>.AddSingleTypeSerializer()</code> renamed to <code>.AddSchemaRegistryAvroDeserializer()</code></li>
</ul>
<p>Related to Decompression:</p>
<ul>
<li><code>IDecompressor</code> interface created.</li>
<li><code>.AddCompressor()</code> renamed to <code>.AddDecompressor()</code>.</li>
<li>Created <code>GzipMessageDecompressor</code> that implements the <code>.Decompress()</code> method.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="33-consumer-batching-configuration">3.3 Consumer Batching Configuration<a href="#33-consumer-batching-configuration" class="hash-link" aria-label="Direct link to 3.3 Consumer Batching Configuration" title="Direct link to 3.3 Consumer Batching Configuration">​</a></h4>
<p>Consumer batching configuration renamed from <code>.BatchConsume()</code> to <code>.AddBatching()</code>. Update your configuration accordingly.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="34-async-support-for-message-type-resolvers-and-schema-registry-resolvers">3.4. Async Support for Message Type Resolvers and Schema Registry Resolvers<a href="#34-async-support-for-message-type-resolvers-and-schema-registry-resolvers" class="hash-link" aria-label="Direct link to 3.4. Async Support for Message Type Resolvers and Schema Registry Resolvers" title="Direct link to 3.4. Async Support for Message Type Resolvers and Schema Registry Resolvers">​</a></h4>
<blockquote>
<p>Related Issues: <a href="https://github.com/Farfetch/kafkaflow/issues/302" target="_blank" rel="noopener noreferrer">#302</a>, <a href="https://github.com/Farfetch/kafkaflow/issues/305" target="_blank" rel="noopener noreferrer">#305</a></p>
</blockquote>
<p>In both <code>IMessageTypeResolvers</code> and <code>ISchemaRegistryTypeNameResolver</code> the interface methods only supported sync calls before KafkaFlow v3.
To accommodate some use cases where calls to these methods can be parallelized, the methods defined in this interface were refactored to support the Async pattern.</p>
<p>If your application has a concrete implementation of these interfaces, please make sure to update your code accordingly by using the async/await pattern. Here is the list of changes related to this subject:</p>
<ul>
<li><code>Resolve()</code> renamed to <code>ResolveAsync()</code> in <code>ISchemaRegistryTypeNameResolver</code> and now returns a <code>Task&lt;string&gt;</code>.</li>
<li><code>OnConsume()</code> renamed to <code>OnConsumeAsync()</code> in <code>IMessageTypeResolver</code> and returns a <code>ValueTask&lt;Type&gt;</code>.</li>
<li><code>OnProduce()</code> renamed to <code>OnProduceAsync()</code> in <code>IMessageTypeResolver</code> and returns a <code>ValueTask</code>.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="new-features">New Features<a href="#new-features" class="hash-link" aria-label="Direct link to New Features" title="Direct link to New Features">​</a></h2>
<p>Additionally, with the update to v3, some quality-of-life features were added to KafkaFlow core, mainly related to how workers are configured.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-dynamic-workers-calculation">1. Dynamic Workers Calculation<a href="#1-dynamic-workers-calculation" class="hash-link" aria-label="Direct link to 1. Dynamic Workers Calculation" title="Direct link to 1. Dynamic Workers Calculation">​</a></h3>
<p>One important feature added to KafkaFlow v3 was the ability to calculate how many workers are handling the message consumption dynamically. Please check the feature documentation <a href="https://farfetch.github.io/kafkaflow/docs/guides/consumers/dynamic-workers-configuration" target="_blank" rel="noopener noreferrer">here</a>.</p>
<p>In load scenarios where the consumer needs to ramp up message consumption to reduce the consumer lag, increasing the number of workers can be a valid strategy in this scenario.</p>
<p>Before, the number of workers was determined statically by configuration at the time of application startup. With KafkaFlow v3, a new method was introduced that supports calculating the number of available workers periodically. This allows the application to adapt constantly and also being able to scale the number of workers during the application&#x27;s lifetime.</p>
<p>To accommodate this requirement multiple changes were made to the core of KafkaFlow, next we will go through some of these changes.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="11-dynamic-worker-pool-scaling-configuration">1.1 Dynamic Worker Pool Scaling Configuration<a href="#11-dynamic-worker-pool-scaling-configuration" class="hash-link" aria-label="Direct link to 1.1 Dynamic Worker Pool Scaling Configuration" title="Direct link to 1.1 Dynamic Worker Pool Scaling Configuration">​</a></h3>
<blockquote>
<p>Related Issues: <a href="https://github.com/Farfetch/kafkaflow/issues/429" target="_blank" rel="noopener noreferrer">#429</a></p>
</blockquote>
<p>Two new overrides were added to the consumer configuration. Nevertheless, the previous method of statically determining the worker count is still available.</p>
<p>The new overrides added were:</p>
<ul>
<li><code>WithWorkersCount(Func&lt;WorkersCountContext, IDependencyResolver, Task&lt;int&gt;&gt; calculator)</code></li>
<li><code>WithWorkersCount(Func&lt;WorkersCountContext, IDependencyResolver, Task&lt;int&gt;&gt; calculator, TimeSpan evaluationInterval)</code></li>
</ul>
<p>The difference between both overrides is that the first works with a predefined frequency of 5 minutes between calls to the delegate that returns the number of workers. While in the second override that frequency can be user-defined.</p>
<p>Additionally, the delegate receives a <code>WorkersCountContext</code> that sends some consumer-related context to the callback like the Consumer Name, the Consumer Group Key and the Consumer Partitions Assignment. Also, the <code>IDependencyResolver</code> is made available in case some dependencies need to be resolved to determine the worker count.</p>
<p>This means that a consumer worker count can be configured like this:</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AddConsumer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    consumerBuilder </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> consumerBuilder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Topic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;test-topic&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithGroupId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;group1&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithWorkersCount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> resolver</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// Use whatever logic to determine the worker count</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetWorkerCount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> resolver</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TimeSpan</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">FromMinutes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">15</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="12-improved-mechanism-for-signalling-message-processing-completion">1.2 Improved Mechanism for Signalling Message Processing Completion<a href="#12-improved-mechanism-for-signalling-message-processing-completion" class="hash-link" aria-label="Direct link to 1.2 Improved Mechanism for Signalling Message Processing Completion" title="Direct link to 1.2 Improved Mechanism for Signalling Message Processing Completion">​</a></h3>
<blockquote>
<p>Related Issues: <a href="https://github.com/Farfetch/kafkaflow/issues/426" target="_blank" rel="noopener noreferrer">#426</a></p>
</blockquote>
<p>For the KafkaFlow engine to adapt to the dynamic change of workers, the way the messages are signaled as completed also needed to be updated because the workers can only be scaled after all the messages in the worker&#x27;s buffers are signaled as completed.</p>
<p>To achieve this, a new method in the message context was provided to signal the message completion <code>.Complete()</code>. Additionally, a new property called <code>AutoMessageCompletion</code> was added to signal if KafkaFlow should signal the message as completed automatically which is the default behavior. This property is useful for scenarios where we don&#x27;t want to complete the message right away, for example in Batch Consume scenarios.</p>
<ul>
<li>Use <code>WithManualMessageCompletion()</code> instead of <code>WithManualStoreOffsets()</code>.</li>
<li>Use <code>context.ConsumerContext.Complete()</code> instead of <code>context.ConsumerContext.StoreOffset()</code>.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="13-expose-worker-events-to-client-applications">1.3 Expose Worker Events to Client Applications<a href="#13-expose-worker-events-to-client-applications" class="hash-link" aria-label="Direct link to 1.3 Expose Worker Events to Client Applications" title="Direct link to 1.3 Expose Worker Events to Client Applications">​</a></h3>
<blockquote>
<p>Related Issues: <a href="https://github.com/Farfetch/kafkaflow/issues/427" target="_blank" rel="noopener noreferrer">#427</a></p>
</blockquote>
<p>KafkaFlow now exposes some events related to its internal functionality. The events that are being published are the following:</p>
<ul>
<li>MessageProduceStarted</li>
<li>MessageProduceCompleted</li>
<li>MessageProduceError</li>
<li>MessageConsumeStarted</li>
<li>MessageConsumeCompleted</li>
<li>MessageConsumeError</li>
<li>WorkerStopping</li>
<li>WorkerStopped</li>
<li>WorkerProcessingEnded</li>
</ul>
<p>While worker-related events are available through the <code>IWorker</code> reference, the message-related events can be subscribed using the <code>.SubscribeGlobalEvents()</code> configuration method.</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">services</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AddKafka</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kafka </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> kafka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">UseConsoleLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SubscribeGlobalEvents</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hub </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            hub</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">MessageConsumeStarted</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Subscribe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">eventContext </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> Console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WriteLine</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Message Consume Started&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            hub</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">MessageConsumeError</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Subscribe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">eventContext </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> Console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WriteLine</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Message Consume Error&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            hub</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">MessageConsumeCompleted</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Subscribe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">eventContext </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> Console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WriteLine</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Message Consume Completed&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            hub</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">MessageProduceStarted</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Subscribe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">eventContext </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> Console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WriteLine</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Message Produce Started&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            hub</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">MessageProduceError</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Subscribe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">eventContext </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> Console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WriteLine</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Message Produce Error&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            hub</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">MessageProduceCompleted</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Subscribe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">eventContext </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> Console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WriteLine</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Message Produce Completed&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="14-improve-dependency-injection-scope-management">1.4 Improve Dependency Injection Scope Management<a href="#14-improve-dependency-injection-scope-management" class="hash-link" aria-label="Direct link to 1.4 Improve Dependency Injection Scope Management" title="Direct link to 1.4 Improve Dependency Injection Scope Management">​</a></h3>
<blockquote>
<p>Related Issues: <a href="https://github.com/Farfetch/kafkaflow/issues/428" target="_blank" rel="noopener noreferrer">#428</a></p>
</blockquote>
<p>Some improvements were made to the way the dependency scopes are managed to provide more fine-grained control over dependency lifecycles. Here are some changes that were made in this context:</p>
<ul>
<li><code>IMessageContext</code> now exposes a property <code>DependencyResolver</code> which is intrinsically tied to the scope of a single processed message.</li>
<li><code>IConsumerContext</code> introduces two properties: <code>ConsumerDependencyResolver</code> and <code>WorkerDependencyResolver</code>. The former will resolve dependencies tied to the lifecycle of a single consumer, whereas the latter caters to a single worker&#x27;s lifecycle.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-improved-worker-distribution-strategy">2. Improved Worker Distribution Strategy<a href="#2-improved-worker-distribution-strategy" class="hash-link" aria-label="Direct link to 2. Improved Worker Distribution Strategy" title="Direct link to 2. Improved Worker Distribution Strategy">​</a></h2>
<blockquote>
<p>Related Issues: <a href="https://github.com/Farfetch/kafkaflow/issues/440" target="_blank" rel="noopener noreferrer">#440</a></p>
</blockquote>
<p>KafkaFlow v2 already provided a method to define the worker to handle a message when consuming using the <code>IDistributionStrategy</code> interface. However, the only context provided by this method was the partition key of the message, which sometimes can be insufficient to determine how to distribute messages across workers in more complex scenarios.</p>
<p>With KafkaFlow v3 this interface got renamed to <code>IWorkerDistributionStrategy</code> and now the method <code>.GetWorkerAsync()</code> receives a <code>WorkerDistributionContext</code> structure. Properties like message topic and partition are now part of the context which provides more flexibility when choosing the worker to handle a message.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>Please ensure you review and adapt your codebase according to these changes. If you encounter any issues or need assistance, feel free to <a href="https://github.com/Farfetch/kafkaflow#get-in-touch" target="_blank" rel="noopener noreferrer">reach out</a> to the KafkaFlow community. Thank you for using KafkaFlow!</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/farfetch/kafkaflow/tree/master/website/docs/guides/migration/from-v2-to-v3.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/kafkaflow/docs/category/migration"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Migration</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/kafkaflow/docs/category/reference"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Reference</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#table-of-contents" class="table-of-contents__link toc-highlight">Table of Contents</a></li><li><a href="#prerequisites" class="table-of-contents__link toc-highlight">Prerequisites</a></li><li><a href="#update-package-references" class="table-of-contents__link toc-highlight">Update package references</a></li><li><a href="#breaking-changes" class="table-of-contents__link toc-highlight">Breaking Changes</a><ul><li><a href="#1-update-to-net-6-with-admin-packages" class="table-of-contents__link toc-highlight">1. Update to .NET 6 with Admin Packages</a></li><li><a href="#2-ui-dashboard-url-change" class="table-of-contents__link toc-highlight">2. UI Dashboard URL Change</a></li><li><a href="#3-removed-packages-and-core-changes" class="table-of-contents__link toc-highlight">3. Removed Packages and Core Changes</a></li></ul></li><li><a href="#new-features" class="table-of-contents__link toc-highlight">New Features</a><ul><li><a href="#1-dynamic-workers-calculation" class="table-of-contents__link toc-highlight">1. Dynamic Workers Calculation</a></li><li><a href="#11-dynamic-worker-pool-scaling-configuration" class="table-of-contents__link toc-highlight">1.1 Dynamic Worker Pool Scaling Configuration</a></li><li><a href="#12-improved-mechanism-for-signalling-message-processing-completion" class="table-of-contents__link toc-highlight">1.2 Improved Mechanism for Signalling Message Processing Completion</a></li><li><a href="#13-expose-worker-events-to-client-applications" class="table-of-contents__link toc-highlight">1.3 Expose Worker Events to Client Applications</a></li><li><a href="#14-improve-dependency-injection-scope-management" class="table-of-contents__link toc-highlight">1.4 Improve Dependency Injection Scope Management</a></li></ul></li><li><a href="#2-improved-worker-distribution-strategy" class="table-of-contents__link toc-highlight">2. Improved Worker Distribution Strategy</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/kafkaflow/docs">Introduction</a></li><li class="footer__item"><a class="footer__link-item" href="/kafkaflow/docs/category/getting-started">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/kafkaflow/docs/category/guides">Guides</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/kafkaflow" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://join.slack.com/t/kafkaflow/shared_invite/zt-puihrtcl-NnnylPZloAiVlQfsw~RD6Q" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://farfetchtechblog.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">FARFETCH Blog</a></li><li class="footer__item"><a href="https://github.com/farfetch/kafkaflow" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 FARFETCH UK Limited. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>