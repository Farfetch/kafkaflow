"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[511],{28453:(e,s,n)=>{n.d(s,{R:()=>o,x:()=>i});var t=n(96540);const a={},d=t.createContext(a);function o(e){const s=t.useContext(d);return t.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function i(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),t.createElement(d.Provider,{value:s},e.children)}},39208:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>r,contentTitle:()=>o,default:()=>h,frontMatter:()=>d,metadata:()=>i,toc:()=>c});var t=n(74848),a=n(28453);const d={sidebar_position:5},o="Batch Consume Middleware",i={id:"guides/middlewares/batch-consume-middleware",title:"Batch Consume Middleware",description:"In this section, we will learn how to use the Batch Consume Middleware.",source:"@site/versioned_docs/version-2.x/guides/middlewares/batch-consume-middleware.md",sourceDirName:"guides/middlewares",slug:"/guides/middlewares/batch-consume-middleware",permalink:"/kafkaflow/docs/2.x/guides/middlewares/batch-consume-middleware",draft:!1,unlisted:!1,editUrl:"https://github.com/farfetch/kafkaflow/tree/master/website/versioned_docs/version-2.x/guides/middlewares/batch-consume-middleware.md",tags:[],version:"2.x",sidebarPosition:5,frontMatter:{sidebar_position:5},sidebar:"tutorialSidebar",previous:{title:"Compressor Middleware",permalink:"/kafkaflow/docs/2.x/guides/middlewares/compressor-middleware"},next:{title:"Consumer Throttling",permalink:"/kafkaflow/docs/2.x/guides/middlewares/consumer-throttling-middleware"}},r={},c=[{value:"How to use it",id:"how-to-use-it",level:2}];function l(e){const s={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.h1,{id:"batch-consume-middleware",children:"Batch Consume Middleware"}),"\n",(0,t.jsx)(s.p,{children:"In this section, we will learn how to use the Batch Consume Middleware."}),"\n",(0,t.jsx)(s.p,{children:"The Batch Consume Middleware is used to accumulate a number of messages or wait some time to build a collection of messages and deliver them to the next middleware to be processed, as it was just one message."}),"\n",(0,t.jsx)(s.h2,{id:"how-to-use-it",children:"How to use it"}),"\n",(0,t.jsxs)(s.p,{children:["Install the ",(0,t.jsx)(s.a,{href:"https://www.nuget.org/packages/KafkaFlow.BatchConsume",children:"KafkaFlow.BatchConsume"})," package."]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"dotnet add package KafkaFlow.BatchConsume\n"})}),"\n",(0,t.jsxs)(s.p,{children:["On the configuration, use the ",(0,t.jsx)(s.code,{children:"BatchConsume"})," extension method to add the middleware to your consumer middlewares."]}),"\n",(0,t.jsxs)(s.p,{children:["The ",(0,t.jsx)(s.code,{children:"BatchConsume"})," method has two arguments:"]}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:"The first one must define the maximum batch size."}),"\n",(0,t.jsxs)(s.li,{children:["The second one defines the ",(0,t.jsx)(s.code,{children:"TimeSpan"})," that the Middleware waits for new messages to be part of the batch."]}),"\n"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-csharp",children:'services.AddKafka(kafka => kafka\n    .AddCluster(cluster => cluster\n        .WithBrokers(new[] { "localhost:9092" })\n        .AddConsumer(\n            consumerBuilder => consumerBuilder\n            ...\n            .AddMiddlewares(\n                middlewares => middlewares\n                    ...\n                    .BatchConsume(100, TimeSpan.FromSeconds(10)) // Configuration of the BatchConsumeMiddleware\n                    .Add<HandlingMiddleware>() // Middleware to process the batch\n            )\n        )\n    )\n);\n'})}),"\n",(0,t.jsxs)(s.p,{children:["To access the batch from the next middleware, use the ",(0,t.jsx)(s.code,{children:"GetMessagesBatch"})," method accessible through the ",(0,t.jsx)(s.code,{children:"context"})," argument."]}),"\n",(0,t.jsx)(s.admonition,{type:"warning",children:(0,t.jsxs)(s.p,{children:["When using the ",(0,t.jsx)(s.code,{children:"Batch Consume"})," middleware, the ",(0,t.jsx)(s.code,{children:"IServiceScopeFactory"})," should be used to create scopes instead of the ",(0,t.jsx)(s.code,{children:"IServiceProvider"}),", as the latter may dispose the scope."]})}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-csharp",children:"using KafkaFlow.BatchConsume;\n\ninternal class HandlingMiddleware : IMessageMiddleware\n{\n    public Task Invoke(IMessageContext context, MiddlewareDelegate next)\n    {\n        var batch = context.GetMessagesBatch();\n        \n        (...)\n\n        return Task.CompletedTask;\n    }\n}\n"})}),"\n",(0,t.jsx)(s.admonition,{type:"tip",children:(0,t.jsxs)(s.p,{children:["You can find a sample on batch processing ",(0,t.jsx)(s.a,{href:"https://github.com/Farfetch/kafkaflow/tree/master/samples/KafkaFlow.Sample.BatchOperations",children:"here"}),"."]})})]})}function h(e={}){const{wrapper:s}={...(0,a.R)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}}}]);