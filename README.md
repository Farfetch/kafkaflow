![Build Master](https://github.com/Farfetch/kafka-flow/workflows/Build%20Master/badge.svg?branch=master) [![Codacy Badge](https://api.codacy.com/project/badge/Grade/49878b337fde46839c5f08051c2ba098)](https://app.codacy.com/gh/Farfetch/kafka-flow?utm_source=github.com&utm_medium=referral&utm_content=Farfetch/kafka-flow&utm_campaign=Badge_Grade_Dashboard) [<img src="https://img.shields.io/badge/slack-@kafkaflow/questions-green.svg?logo=slack">](https://join.slack.com/t/kafkaflow/shared_invite/zt-fqw06n2u-1lA5Mz_VnSPGhRgfT97SPQ)

## Packages

| Package                                                                                                            | NuGet Stable                                                                                                                                                                                      | Downloads                                                                                                                                                                                          |
| ------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| [KafkaFlow](https://www.nuget.org/packages/KafkaFlow/)                                                             | [![KafkaFlow](https://img.shields.io/nuget/v/KafkaFlow.svg)](https://www.nuget.org/packages/KafkaFlow/)                                                                                           | [![KafkaFlow](https://img.shields.io/nuget/dt/KafkaFlow.svg)](https://www.nuget.org/packages/KafkaFlow/)                                                                                           |
| [KafkaFlow.Abstractions](https://www.nuget.org/packages/KafkaFlow.Abstractions/)                                   | [![KafkaFlow.Abstractions](https://img.shields.io/nuget/v/KafkaFlow.Abstractions.svg)](https://www.nuget.org/packages/KafkaFlow.Abstractions/)                                                    | [![KafkaFlow](https://img.shields.io/nuget/dt/KafkaFlow.Abstractions.svg)](https://www.nuget.org/packages/KafkaFlow.Abstractions/)                                                                 |
| [KafkaFlow.Serializer](https://www.nuget.org/packages/KafkaFlow.Serializer/)                                       | [![KafkaFlow.Serializer](https://img.shields.io/nuget/v/KafkaFlow.Serializer.svg)](https://www.nuget.org/packages/KafkaFlow.Serializer/)                                                          | [![KafkaFlow.Serializer](https://img.shields.io/nuget/dt/KafkaFlow.Serializer.svg)](https://www.nuget.org/packages/KafkaFlow.Serializer/)                                                          |
| [KafkaFlow.Serializer.ProtoBuf](https://www.nuget.org/packages/KafkaFlow.Serializer.ProtoBuf/)                     | [![KafkaFlow.Serializer.ProtoBuf](https://img.shields.io/nuget/v/KafkaFlow.Serializer.ProtoBuf.svg)](https://www.nuget.org/packages/KafkaFlow.Serializer.ProtoBuf/)                               | [![KafkaFlow.Serializer.ProtoBuf](https://img.shields.io/nuget/dt/KafkaFlow.Serializer.ProtoBuf.svg)](https://www.nuget.org/packages/KafkaFlow.Serializer.ProtoBuf/)                               |
| [KafkaFlow.Serializer.Json](https://www.nuget.org/packages/KafkaFlow.Serializer.Json/)                             | [![KafkaFlow.Serializer.Json](https://img.shields.io/nuget/v/KafkaFlow.Serializer.Json.svg)](https://www.nuget.org/packages/KafkaFlow.Serializer.Json/)                                           | [![KafkaFlow.Serializer.Json](https://img.shields.io/nuget/dt/KafkaFlow.Serializer.Json.svg)](https://www.nuget.org/packages/KafkaFlow.Serializer.Json/)                                           |
| [KafkaFlow.Serializer.NewtonsoftJson](https://www.nuget.org/packages/KafkaFlow.Serializer.NewtonsoftJson/)         | [![KafkaFlow.Serializer.NewtonsoftJson](https://img.shields.io/nuget/v/KafkaFlow.Serializer.NewtonsoftJson.svg)](https://www.nuget.org/packages/KafkaFlow.Serializer.NewtonsoftJson/)             | [![KafkaFlow.Serializer.NewtonsoftJson](https://img.shields.io/nuget/dt/KafkaFlow.Serializer.NewtonsoftJson.svg)](https://www.nuget.org/packages/KafkaFlow.Serializer.NewtonsoftJson/)             |
| [KafkaFlow.Compressor](https://www.nuget.org/packages/KafkaFlow.Compressor/)                                       | [![KafkaFlow.Compressor](https://img.shields.io/nuget/v/KafkaFlow.Compressor.svg)](https://www.nuget.org/packages/KafkaFlow.Compressor/)                                                          | [![KafkaFlow.Compressor](https://img.shields.io/nuget/dt/KafkaFlow.Compressor.svg)](https://www.nuget.org/packages/KafkaFlow.Compressor/)                                                          |
| [KafkaFlow.Compressor.Gzip](https://www.nuget.org/packages/KafkaFlow.Compressor.Gzip/)                             | [![KafkaFlow.Compressor.Gzip](https://img.shields.io/nuget/v/KafkaFlow.Compressor.Gzip.svg)](https://www.nuget.org/packages/KafkaFlow.Compressor.Gzip/)                                           | [![KafkaFlow.Compressor.Gzip](https://img.shields.io/nuget/dt/KafkaFlow.Compressor.Gzip.svg)](https://www.nuget.org/packages/KafkaFlow.Compressor.Gzip/)                                           |
| [KafkaFlow.TypedHandler](https://www.nuget.org/packages/KafkaFlow.TypedHandler/)                                   | [![KafkaFlow.TypedHandler](https://img.shields.io/nuget/v/KafkaFlow.TypedHandler.svg)](https://www.nuget.org/packages/KafkaFlow.TypedHandler/)                                                    | [![KafkaFlow.TypedHandler](https://img.shields.io/nuget/dt/KafkaFlow.TypedHandler.svg)](https://www.nuget.org/packages/KafkaFlow.TypedHandler/)                                                    |
| [KafkaFlow.Microsoft.DependencyInjection](https://www.nuget.org/packages/KafkaFlow.Microsoft.DependencyInjection/) | [![KafkaFlow.Microsoft.DependencyInjection](https://img.shields.io/nuget/v/KafkaFlow.Microsoft.DependencyInjection.svg)](https://www.nuget.org/packages/KafkaFlow.Microsoft.DependencyInjection/) | [![KafkaFlow.Microsoft.DependencyInjection](https://img.shields.io/nuget/dt/KafkaFlow.Microsoft.DependencyInjection.svg)](https://www.nuget.org/packages/KafkaFlow.Microsoft.DependencyInjection/) |
| [KafkaFlow.Unity](https://www.nuget.org/packages/KafkaFlow.Unity/)                                                 | [![KafkaFlow.Unity](https://img.shields.io/nuget/v/KafkaFlow.Unity.svg)](https://www.nuget.org/packages/KafkaFlow.Unity/)                                                                         | [![KafkaFlow.Unity](https://img.shields.io/nuget/dt/KafkaFlow.Unity.svg)](https://www.nuget.org/packages/KafkaFlow.Unity/)                                                                         |

## Why you should use KafkaFlow

The main features of KafkaFlow are the capacity to process messages in parallel and [middlewares](https://github.com/Farfetch/kafka-flow#its-all-about-middlewares) support. You can define how many workers a consumer will have, this means how many messages will be processed at the same time for that consumer.

KafkaFlow uses [Confluent Kafka Client](https://github.com/confluentinc/confluent-kafka-dotnet).

## Features

-   Fluent configuration
-   Multiple cluster support
-   Multiple workers consuming the same topic
-   Message order guarantee for the same partition key
-   Multiple consumer groups in the same topic
-   Multiple topics in the same consumer
-   Different work distribution strategies
-   Middleware support for consumers and producers implementing `IMessageMiddleware` interface
-   Serialization middleware (ProtoBuf and Json are shipped with the framework but they have different nuget packages, you can support custom serialization using `IMessageSerializer` interface)
-   Compression middleware (Gzip is shipped with the framework but it has a different nuget package, you can support custom compressions using `IMessageCompressor` interface)
-   Graceful shutdown (waits for the message processor ends to shutdown)
-   Store message offset only when message processing ends, avoiding message loss (or you can store it manually)
-   Supports .NET Core and .NET Framework
-   Can be used with any dependency injection framework

## Usage

### .NET Core

Install [KafkaFlow.Microsoft.DependencyInjection](https://www.nuget.org/packages/KafkaFlow.Microsoft.DependencyInjection/) package

```csharp
public class Startup
{
    public void ConfigureServices(IServiceCollection services)
    {
        services.AddKafka(
            kafka => kafka
                // You must implement IlogHandler interface and replace YourLogHandler
                .UseLogHandler<YourLogHandler>() 
                .AddCluster(
                    cluster => cluster
                        .WithBrokers(new[] { "localhost:9092" })
                        .AddConsumer(
                            consumer => consumer
                                .Topic("test-topic")
                                .WithGroupId("print-console-handler")
                                .WithBufferSize(100)
                                .WithWorkersCount(10)
                                .WithAutoOffsetReset(AutoOffsetReset.Latest)
                                .AddMiddlewares(
                                    middlewares => middlewares
                                        // Install KafkaFlow.Compressor and Install KafkaFlow.Compressor.Gzip
                                        .AddCompressor<GzipMessageCompressor>() 
                                        // Install KafkaFlow.Serializer and Install KafkaFlow.Serializer.Protobuf
                                        // You must implement IMessageTypeResolver and replace YourMessageTypeResolver
                                        .AddSerializer<ProtobufMessageSerializer, YourMessageTypeResolver>()
                                        // Install KafkaFlow.TypedHandler
                                        .AddTypedHandlers(
                                            handlers => handlers
                                                .WithHandlerLifetime(InstanceLifetime.Singleton)
                                                .AddHandler<PrintConsoleHandler>())
                                )
                        )
                        .AddProducer(
                            "producer-name",
                            producer => producer
                                .DefaultTopic("test-topic")
                                .AddMiddlewares(
                                    middlewares => middlewares
                                        .AddSerializer<ProtobufMessageSerializer, YourMessageTypeResolver>()
                                        .AddCompressor<GzipMessageCompressor>()
                                )
                        )
                )
        );
    }

    public void Configure(
        IApplicationBuilder app,
        IHostApplicationLifetime lifetime,
        IServiceProvider serviceProvider)
    {
        var bus = serviceProvider.CreateKafkaBus();

        // Starts and stops the bus when you app starts and stops to graceful shutdown
        lifetime.ApplicationStarted.Register(
            a => bus.StartAsync(lifetime.ApplicationStopped).GetAwaiter().GetResult(),
            null);
    }
}
```

-   See the [samples](/samples) folder for more usages
-   We natively supports [Microsoft DI](https://www.nuget.org/packages/KafkaFlow.Microsoft.DependencyInjection/) and [Unity 5](https://www.nuget.org/packages/KafkaFlow.Unity/).
-   You can use other dependency injection frameworks and .NET Framework (see [here](/docs/di-containers.md))

## Workers

Workers are responsible for processing the messages when consuming. You define how many workers a consumer will have. The workers process the messages in parallel, and by default, messages with the same partition key are processed by the same worker, so that the message order is respected for the same partition key. Every worker has a buffer to avoid idling when many messages arrive with the same partition key for any other worker. The buffer size should be dimensioned depending on how many messages arrive with the same partition key, on average. When the bus is requested to stop, every worker receives the stop command and it only releases the stop call when it ends the current message and stores it in the OffsetManager. The OffsetManager is a component that receives all the offsets from the workers and orchestrates them before storing into Kafka; this avoids an offset override when we have many messages being processed at the same time. Even when you choose to use the manual offset store option, you will store the offset in the OffsetManager, and will then store the offsets in Kafka when possible. When the application stops, there is a big chance to have processed messages already stored in OffsetManager but not stored in Kafka. In this scenario, when the application starts again, these messages will be processed again. Your application must be prepared to deal with it.

## It's all about middlewares

KafkaFlow is very middleware-oriented. Messages will be delivered to a middleware, will then be passed to another middleware, and so on. The middlewares can transform the messages, allowing them to apply serialization and compression, for example. You can log the messages, handle exceptions, apply retry policies (maybe using [Polly](https://github.com/App-vNext/Polly)), collect metrics, and many other things. **The middlewares are executed in the same order that they are defined in the configuration. Every product/consumer has its own middlewares instances, so, the instances are not shared between different consumers/producers, but when consuming, the instances are shared between the workers of the same consumer**

Every middleware must implement the `IMessageMiddleware` interface. You must implement the method `Invoke`, which receives two parameters: the `IMessageContext` and the `MiddlewareDelegate`. The `IMessageContext` is an object that has the message, message metadata, and consumer/producer information. The `MiddlewareDelegate` is a `async` method that calls the next middleware; you can short-circuit the message execution by just not calling the next middleware or putting it inside a `try` block so you can catch any exceptions thrown by the next middlewares.

When consuming, the message will be delivered as a byte array to the first middleware; you will choose the middlewares that will process the messages (you will probably create a middleware to do it or use the [Typed Handler](https://www.nuget.org/packages/KafkaFlow.TypedHandler) depending on the message type). The next message will only be processed after the execution of all the configured middlewares for that consumer.

When producing, the middlewares are called when the `Produce` or `PoduceAsync` of the `IMessageProducer` is called. After the execution of all middlewares, the message will be published to Kafka.

## Contributing

1.  Fork this repository
2.  Follow project guidelines
3.  Do your stuff
4.  Open a pull request following [conventional commits](https://www.conventionalcommits.org/en/v1.0.0/)

### Disclaimer

By sending us your contributions, you are agreeing that your contribution is made subject to the terms of our [Contributor Ownership Statement](https://github.com/Farfetch/.github/blob/master/COS.md)

## Maintainers

-   [filipeesch](https://github.com/filipeesch)
-   [dougolima](https://github.com/dougolima)

## License

[MIT](LICENSE)
